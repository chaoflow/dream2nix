<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>dream2nix documentation</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">dream2nix concept</li><li class="chapter-item expanded "><a href="v1-api/summary.html"><strong aria-hidden="true">2.</strong> draft for modules based API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="v1-api/problems.html"><strong aria-hidden="true">2.1.</strong> problems of the legacy dream2nix</a></li><li class="chapter-item expanded "><a href="v1-api/users.html"><strong aria-hidden="true">2.2.</strong> users of dream2nix</a></li><li class="chapter-item expanded "><a href="v1-api/packaging/nodejs-init-project.html"><strong aria-hidden="true">2.3.</strong> v1 packaging: project initialization</a></li><li class="chapter-item expanded "><a href="v1-api/packaging/nodejs-workspaces.html"><strong aria-hidden="true">2.4.</strong> v1 packaging: workspaces</a></li><li class="chapter-item expanded "><a href="v1-api/packaging/nodejs-multiple-repos.html"><strong aria-hidden="true">2.5.</strong> v1 packaging: multiple repos</a></li><li class="chapter-item expanded "><a href="v1-api/packaging/monorepo.html"><strong aria-hidden="true">2.6.</strong> v1 packaging: monorepo</a></li><li class="chapter-item expanded "><a href="v1-api/consuming/inspect-options.html"><strong aria-hidden="true">2.7.</strong> v1 consuming: inspect package options</a></li><li class="chapter-item expanded "><a href="v1-api/consuming/override.html"><strong aria-hidden="true">2.8.</strong> v1 consuming: override packages</a></li><li class="chapter-item expanded "><a href="v1-api/integrating/integrate-lang2nix-pure.html"><strong aria-hidden="true">2.9.</strong> v1 integrating: lang2nix tool (pure)</a></li><li class="chapter-item expanded "><a href="v1-api/integrating/integrate-lang2nix-impure.html"><strong aria-hidden="true">2.10.</strong> v1 integrating: lang2nix tool (code-gen/impure)</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Development Roundups</li><li class="chapter-item expanded "><a href="development-roundups/2022-april-june.html"><strong aria-hidden="true">3.</strong> April - June 2022</a></li><li class="chapter-item expanded "><a href="development-roundups/2022-july-september.html"><strong aria-hidden="true">4.</strong> July - September 2022</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">dream2nix documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p align="center">
  <picture>
    <source width="600" media="(prefers-color-scheme: dark)" srcset="https://gist.githubusercontent.com/DavHau/755fed3774e89c0b9b8953a0a25309fa/raw/0312cc4f785de36212f4303d23298f07c13549dc/dream2nix-dark.png">
    <source width="600" media="(prefers-color-scheme: light)" srcset="https://gist.githubusercontent.com/DavHau/755fed3774e89c0b9b8953a0a25309fa/raw/e2a12a60ae49aa5eb11b42775abdd1652dbe63c0/dream2nix-01.png">
    <img width="600" alt="dream2nix - A framework for automated nix packaging" src="https://gist.githubusercontent.com/DavHau/755fed3774e89c0b9b8953a0a25309fa/raw/e2a12a60ae49aa5eb11b42775abdd1652dbe63c0/dream2nix-01.png">
  </picture>
  <br>
  Automate reproducible packaging for various language ecosystems
  <br>
  <a href="https://nix-community.github.io/dream2nix/">Documentation</a> |
  <a href="https://github.com/nix-community/dream2nix/tree/main/modules/drvs">Examples</a>
</p>
<p>!!! Warning: dream2nix is unstable software. While simple UX is one of our main focus points, the APIs  are still under development. Do expect changes that will break your setup.</p>
<h3 id="funding"><a class="header" href="#funding">Funding</a></h3>
<p>This project was funded through the <a href="https://nlnet.nl/assure">NGI Assure</a> Fund, a fund established by <a href="https://nlnet.nl/">NLnet</a> with financial support from the European Commission's <a href="https://ngi.eu/">Next Generation Internet</a> programme, under the aegis of DG Communications Networks, Content and Technology under grant agreement No 957073. <strong>Applications are still open, you can <a href="https://nlnet.nl/propose">apply today</a></strong>.</p>
<p>If your organization wants to support the project with extra funding in order to add support for more languages or new features, please contact one of the maintainers.</p>
<h3 id="documentation"><a class="header" href="#documentation">Documentation</a></h3>
<p><a href="https://nix-community.github.io/dream2nix">👉 To the docs</a></p>
<h3 id="presentations"><a class="header" href="#presentations">Presentations</a></h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=AsCvRZukX0E">👉 2023: dream2nix based on drv-parts</a></li>
<li><a href="https://www.youtube.com/watch?v=jqCfHMvCsfQ">👉 2021: Original dream2nix presentation</a> (Examples are outdated)</li>
</ul>
<h3 id="get-in-touch"><a class="header" href="#get-in-touch">Get in touch</a></h3>
<p><a href="https://matrix.to/#/#dream2nix:nixos.org">👉 matrix chat room</a></p>
<h3 id="contribute"><a class="header" href="#contribute">Contribute</a></h3>
<p><a href="https://github.com/nix-community/dream2nix">👉 GitHub repo</a></p>
<p><a href="https://github.com/nix-community/dream2nix/issues">👉 issues</a></p>
<h3 id="goals"><a class="header" href="#goals">Goals</a></h3>
<p>dream2nix focuses on the following aspects:</p>
<ul>
<li>Modularity</li>
<li>Customizability</li>
<li>Maintainability</li>
<li>Code de-duplication across 2nix solutions</li>
<li>Common UI across 2nix solutions</li>
<li>Reduce effort to develop new 2nix solutions</li>
<li>Exploration and adoption of new nix features</li>
<li>Simplified updating of packages</li>
</ul>
<p>The goal of this project is to create a standardized, generic, modular framework for automated packaging solutions, aiming for better flexibility, maintainability and usability.</p>
<p>The intention is to integrate many existing 2nix converters into this framework, thereby improving many of the previously named aspects and providing a unified UX for all 2nix solutions.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dream2nix-v1-api"><a class="header" href="#dream2nix-v1-api">dream2nix v1 API</a></h1>
<ul>
<li><a href="v1-api/../v1-api/problems.html">problems of the current dream2nix</a></li>
<li><a href="v1-api/../v1-api/users.html">users of dream2nix</a></li>
<li>v1 API examples:
<ul>
<li>package maintainers:
<ul>
<li><a href="v1-api/../v1-api/packaging/nodejs-init-project.html">project initialization</a></li>
<li><a href="v1-api/../v1-api/packaging/nodejs-workspaces.html">workspaces</a></li>
<li><a href="v1-api/../v1-api/packaging/nodejs-multiple-repos.html">multiple repos</a></li>
<li><a href="v1-api/../v1-api/packaging/monorepo.html">monorepo</a></li>
</ul>
</li>
<li>consumers:
<ul>
<li><a href="v1-api/../v1-api/consuming/inspect-options.html">inspect package options</a></li>
<li><a href="v1-api/../v1-api/consuming/override.html">override packages</a></li>
</ul>
</li>
<li>integration maintainers:
<ul>
<li><a href="v1-api/../v1-api/integrating/integrate-lang2nix-pure.html">integrate lang2nix tool (pure)</a></li>
<li><a href="v1-api/../v1-api/integrating/integrate-lang2nix-impure.html">integrate lang2nix tool (code-gen/impure)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="problems-of-the-current-dream2nix"><a class="header" href="#problems-of-the-current-dream2nix">Problems of the current dream2nix</a></h1>
<h2 id="integration-of-existing-lang2nix-tools"><a class="header" href="#integration-of-existing-lang2nix-tools">Integration of existing lang2nix tools</a></h2>
<p>Until now, integrating existing 2nix solutions into dream2nix was hard because dream2nix imposed standards which are not met by most existing tools.
With v1 we want to lift most of these restrictions to make integration a no-brainer</p>
<p>(see sections <a href="v1-api/../v1-api/integrate-lang2nix-pure.html">integrate lang2nix tool (pure)</a> and <a href="v1-api/../v1-api/integrate-lang2nix-impure.html">integrate lang2ix tool (impure)</a>.</p>
<h2 id="tied-to-flakes"><a class="header" href="#tied-to-flakes">Tied to flakes</a></h2>
<p>The current api is tied to flakes. The v1 API should not depend on flakes anymore.</p>
<h2 id="composability"><a class="header" href="#composability">Composability</a></h2>
<p>Composability with the current <code>makeFlakeOutputs</code> is bad. Flakes itself aren't nicely composable. Filtering and merging of nested attrsets isn't user friendly.</p>
<p>The v1 api will focus on delivering individual derivations, not flakes.
While we might provide templates, recommendations, and tools for composition, we should not enforce a specific solution onto the user.</p>
<h2 id="overridability"><a class="header" href="#overridability">Overridability</a></h2>
<p>The experience of overriding package- and dependency builds was a bit bumpy so far, as the overriding mechanism was built ontop of override functions provided by nixpkgs' <code>mkDerivation</code>. The v1 API will make use of the nixos module system instead to handle derivation attributes.</p>
<h2 id="discoverability-of-package-options"><a class="header" href="#discoverability-of-package-options">Discoverability of package options</a></h2>
<p>We want users to be able to inspect the API of an individual package. This will also be made possible by the nixos module system.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-users-of-dream2nix"><a class="header" href="#the-users-of-dream2nix">The users of dream2nix</a></h1>
<p>The following groups of users are relevant regarding the v1 API design.</p>
<h2 id="integration-maintainers-level1"><a class="header" href="#integration-maintainers-level1">Integration Maintainers (Level1)</a></h2>
<p>People who use dream2nix to maintain language2nix integrations</p>
<h2 id="package-maintainers-level2"><a class="header" href="#package-maintainers-level2">Package Maintainers (Level2)</a></h2>
<p>People who use dream2nix to maintain nix derivations for packages</p>
<h2 id="consumers-level3"><a class="header" href="#consumers-level3">Consumers (Level3)</a></h2>
<p>People who use and customize packages created via dream2nix</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="initialize-nodejs-project--dev-shell"><a class="header" href="#initialize-nodejs-project--dev-shell">initialize nodejs project + dev shell</a></h1>
<h2 id="load-shell-with-nodejs--npm"><a class="header" href="#load-shell-with-nodejs--npm">load shell with nodejs + npm</a></h2>
<pre><code class="language-console tesh-session=&quot;next-app&quot; tesh-setup=&quot;setup.sh&quot;">$ nix-shell -p https://dream2nix.dev -A devShells.nodejs
</code></pre>
<h2 id="create-my-app"><a class="header" href="#create-my-app">create my-app</a></h2>
<pre><code class="language-console tesh-session=&quot;next-app&quot;">npx create-next-app my-app
</code></pre>
<p>This creates <code>./my-app/package.json</code> and more, using <code>create-next-app</code> as a helper.</p>
<h2 id="create-my-appnix"><a class="header" href="#create-my-appnix">create <code>my-app.nix</code></a></h2>
<p><code>my-app.nix</code></p>
<pre><code class="language-nix">{config, lib, dream2nix, ...}: {

  imports = [
    # default module to create a nodejs package
    dream2nix.modules.nodejs.mkDerivation
    # get package dependencies from package-lock
    dream2nix.modules.nodejs.package-lock
  ];

  # Allows to manipulate dependency builds
  overrides.local.path = ./overrides;

  src = ./my-app;

  # add more mkDerivation attributes here to customize...
}
</code></pre>
<h2 id="create-my-app-shellnix-for-your-dev-shell"><a class="header" href="#create-my-app-shellnix-for-your-dev-shell">create <code>my-app-shell.nix</code> for your dev shell</a></h2>
<p><code>my-app-shell.nix</code></p>
<pre><code class="language-nix">{config, lib, dream2nix, ...}: {

  imports = [
    # the default dev shell for nodejs
    dream2nix.modules.nodejs.mkShell
    # adds dependencies of my-app to the dev shell
    dream2nix.modules.nodejs.package-lock
  ];

  src = ./my-app;

  # include hello from nixpkgs.
  # `deps` is the single source of truth for inputs from the `outside world`.
  # `deps` will later allow us to safely override any dependency.
  deps = {nixpkgs, ...}: {
    inherit (nixpkgs) hello;
  };

  # add hello from nixpkgs to the dev shell
  buildInputs = [
    config.deps.hello
  ]
}
</code></pre>
<h2 id="create-defaultnix-entry-point"><a class="header" href="#create-defaultnix-entry-point">create <code>default.nix</code> entry point</a></h2>
<p><code>default.nix</code></p>
<pre><code class="language-nix">{
  nixpkgs ? import &lt;nixpkgs&gt; {},
  dream2nix ?
    import
    (builtins.fetchTarball &quot;https://dream2nix.dev/tarball/1.0&quot;)
    {inherit nixpkgs;},
}: {
  packages.my-app = dream2nix.eval ./my-app.nix;
  devShells.my-app = dream2nix.eval ./my-app-shell.nix;
}
</code></pre>
<h2 id="build-my-app"><a class="header" href="#build-my-app">build my-app</a></h2>
<pre><code class="language-command">nix-build -f ./default.nix -A packages.my-app
</code></pre>
<h2 id="create-shellnix-used-by-nix-shell-command"><a class="header" href="#create-shellnix-used-by-nix-shell-command">create <code>shell.nix</code> (used by <code>nix-shell</code> command)</a></h2>
<p><code>shell.nix</code></p>
<pre><code class="language-nix">(import ./default.nix {}).devShells.my-app
</code></pre>
<p>Enter the dev shell:</p>
<pre><code class="language-command">nix-shell
</code></pre>
<p>all dependencies of my-app are available</p>
<h2 id="fix-build-of-dependencies-via-overrides"><a class="header" href="#fix-build-of-dependencies-via-overrides">fix build of dependencies via <code>./overrides/</code></a></h2>
<p>Files in <code>./overrides/</code> must always be named like the package they apply to.</p>
<p>Example: <code>./overrides/keytar.nix</code></p>
<h2 id=""><a class="header" href="#"></a></h2>
<pre><code class="language-nix">{config, ...}: {

  # include dependencies from nixpkgs.
  deps = {nixpkgs, ...}: {
    inherit (nixpkgs) 
      libsecret
      pkg-config
      ;
  };

  # add build time dependencies
  nativeBuildInputs = [
    config.deps.libsecret
    config.deps.pkg-config
  ];
}
</code></pre>
<p>Scoped package example: <code>./overrides/@babel/core.nix</code></p>
<h2 id="-1"><a class="header" href="#-1"></a></h2>
<pre><code class="language-nix">{config, ...}: {
  # ...
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build--develop-on-nodejs-workspaces"><a class="header" href="#build--develop-on-nodejs-workspaces">build + develop on nodejs workspaces</a></h1>
<h2 id="assuming-a-packagejson-with-workspaces"><a class="header" href="#assuming-a-packagejson-with-workspaces">assuming a <code>package.json</code> with workspaces</a></h2>
<p><code>package.json</code></p>
<pre><code>{
  &quot;name&quot;: &quot;my-workspaces&quot;,
  &quot;workspaces&quot;: [
    &quot;my-tool&quot;
    &quot;my-first-app&quot;
    &quot;my-second-app&quot;
  ]
}
</code></pre>
<h2 id="define-package-set-via-workspacesnix"><a class="header" href="#define-package-set-via-workspacesnix">define package set via <code>workspaces.nix</code></a></h2>
<pre><code class="language-nix">{config, lib, dream2nix, ...}: {

  imports = [
    dream2nix.modules.nodejs.workspaces
    dream2nix.modules.nodejs.package-lock
  ];

  src = ./.;

  # Allows to manipulate builds of workspace members and their dependencies
  overrides.local.path = ./overrides;
}
</code></pre>
<h2 id="create-defaultnix-entry-point-1"><a class="header" href="#create-defaultnix-entry-point-1">create <code>default.nix</code> entry point</a></h2>
<p><code>default.nix</code></p>
<pre><code class="language-nix">{
  nixpkgs ? import &lt;nixpkgs&gt; {},
  dream2nix ?
    import
    (builtins.fetchTarball &quot;https://dream2nix.dev/tarball/1.0&quot;)
    {inherit nixpkgs;},
}: {
  packages = {
    inherit (dream2nix.lib.mkPackageSet ./workspaces.nix)
      my-tool
      my-first-app
      my-second-app
      ;
  };
}
</code></pre>
<h2 id="configure-package-builds-via-overrides"><a class="header" href="#configure-package-builds-via-overrides">configure package builds via <code>./overrides/</code></a></h2>
<p>Files in <code>./overrides/</code> must always be named like the the package they apply to.</p>
<p>Manipulate my-tool via <code>./overrides/my-tool.nix</code></p>
<pre><code class="language-nix">{config, ...}: {

  # include python from nixpkgs
  deps = {nixpkgs, ...}: {
    inherit (nixpkgs) python;
  };

  buildInputs = [
    config.deps.python
  ];
}
</code></pre>
<p>Manipulate my-first-app via <code>./overrides/my-first-app.nix</code></p>
<pre><code class="language-nix">{config, ...}: {

  # include my-tool from the local workspace
  deps = {workspace, ...}: {
    inherit (workspace) my-tool;
  };

  buildInputs = [
    config.deps.my-tool
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="handle-multiple-repos"><a class="header" href="#handle-multiple-repos">handle multiple repos</a></h1>
<p>Assuming that <code>./repo1</code> and <code>./repo2</code> are separate git repositories.</p>
<p>Both repos have a single package <code>repo1/my-app</code> and <code>repo2/my-tool</code>.</p>
<p>In order to build <code>repo1/my-app</code> we need <code>repo2/my-tool</code> as a build time dependency.</p>
<p>The following structure is assumed:</p>
<pre><code>├── repo1
│  ├── default.nix
│  └── my-app.nix
└── repo2
   ├── default.nix
   └── my-tool.nix
</code></pre>
<h2 id="contents-of-repo1my-appnix"><a class="header" href="#contents-of-repo1my-appnix">contents of <code>repo1/my-app.nix</code></a></h2>
<p><code>repo1/my-app.nix</code></p>
<pre><code class="language-nix">{config, lib, dream2nix, ...}: {

  imports = [
    dream2nix.modules.nodejs.mkDerivation
    dream2nix.modules.nodejs.package-lock
  ];

  src = ./.;

  # include my-tool from repo2
  deps = {repo2, ...}: {
    inherit (repo2) my-tool;
  };

  # add my-tool as build time dependency
  nativeBuildInputs = [
    config.deps.my-tool
  ];

  # use my-tool to build my-app
  buildPhase = ''
    my-tool build
    echo &quot;done building&quot;
  '';
}
</code></pre>
<h2 id="contents-of-repo1defaultnix"><a class="header" href="#contents-of-repo1defaultnix">contents of <code>repo1/default.nix</code></a></h2>
<p><code>repo1/default.nix</code></p>
<pre><code class="language-nix">{
  pkgs ? import &lt;nixpkgs&gt; {},
  dream2nix ?
    import
    (builtins.fetchTarball &quot;https://dream2nix.dev/tarball/1.0&quot;)
    {inherit pkgs;},
}: {
  packages.my-app = dream2nix.eval
    {
      packageSets.nixpkgs = pkgs;
      
      # fetchGit could be used here alternatively
      packageSets.repo2 = import ../repo2/default.nix {};
    }
    ./my-app.nix;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="build-packages-in-a-monorepo"><a class="header" href="#build-packages-in-a-monorepo">build packages in a monorepo</a></h1>
<p>The example mono repo has 3 packages: <code>nodejs-app</code>, <code>python-tool</code>, <code>rust-tool</code>.</p>
<p>The packages <code>python-tool</code> and <code>rust-tool</code> might or might not be built with dream2nix.</p>
<p>The package <code>nodejs-app</code> is built with dream2nix and depends on <code>python-tool</code> and <code>rust-tool</code>.</p>
<h2 id="assuming-this-repo-structure"><a class="header" href="#assuming-this-repo-structure">Assuming this repo structure</a></h2>
<pre><code>├── default.nix
├── overrides
│  ├── nodejs
│  ├── python
│  └── rust
├── nodejs-app
│  └── default.nix
├── python-tool
│  └── default.nix
└── rust-tool
   └── default.nix
</code></pre>
<h2 id="contents-of-nodejs-appdefaultnix"><a class="header" href="#contents-of-nodejs-appdefaultnix">Contents of <code>./nodejs-app/default.nix</code></a></h2>
<p><code>./nodejs-app/default.nix</code></p>
<pre><code class="language-nix">{config, lib, dream2nix, ...}: {

  imports = [
    # default module to create a nodejs package
    dream2nix.modules.nodejs.mkDerivation
    # get package dependencies from package-lock
    dream2nix.modules.nodejs.package-lock
  ];

  # Overrides allow to manipulate dependency builds
  overrides.local.path = ../overrides/nodejs;

  src = ./.;
  
  # include dependencies from nixpkgs and the local monorepo
  # see definition of `packageSets` in ../default.nix
  deps = {nixpkgs, monorepo, ...} @ packageSets: {
    inherit (nixpkgs)
      hello
      ;
    inherit (monorepo)
      python-tool
      rust-tool
      ;
  };

  nativeBuildInputs = [
    config.deps.hello
    config.deps.python-tool
    config.deps.rust-tool
  ];

  configurePhase = ''
    hello --version
    python-tool --version
    rust-tool --version
  '';

  # add more mkDerivation attributes here to customize...
}
</code></pre>
<h2 id="contents-of-defaultnix"><a class="header" href="#contents-of-defaultnix">Contents of <code>./default.nix</code></a></h2>
<p><code>./default.nix</code></p>
<pre><code class="language-nix">{
  nixpkgs ? import &lt;nixpkgs&gt; {},
  dream2nix ?
    import
    (builtins.fetchTarball &quot;https://dream2nix.dev/tarball/1.0&quot;)
    {inherit nixpkgs;},

} @ inputs: let

  makePackage = modules: dream2ix.mkDerivation
    # Package sets available to each package's `deps` function
    {packageSets = {inherit monorepo nixpkgs;};}
    modules;

  monorepo = {
    nodejs-app = makePackage ./nodejs-app;
    python-tool = makePackage ./python-tool;
    rust-tool = makePackage ./rust-tool;
  };

in {
  packages = monorepo;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="inspect-the-api-of-a-package"><a class="header" href="#inspect-the-api-of-a-package">Inspect the API of a package</a></h1>
<p>Downstream users can inspect the api of any consumed package as well as raw package modules</p>
<h2 id="load-the-dream2nix-shell"><a class="header" href="#load-the-dream2nix-shell">Load the dream2nix shell</a></h2>
<pre><code class="language-shell">nix-shell https://dream2nix.dev -A devShells.default
</code></pre>
<h2 id="get-manual-of-package-module"><a class="header" href="#get-manual-of-package-module">Get manual of package module</a></h2>
<p>Assuming a package module in <code>./upstream/my-package.nix</code></p>
<pre><code class="language-shell">$ dream2nix man ./upstream/my-package.nix
</code></pre>
<h2 id="get-manual-of-derivation"><a class="header" href="#get-manual-of-derivation">Get manual of derivation</a></h2>
<p>Assuming derivations defined via <code>./upstream/default.nix</code></p>
<pre><code class="language-shell">dream2nix man ./upstream/default.nix -A packages.my-package
</code></pre>
<h2 id="get-manual-of-flake-attribute"><a class="header" href="#get-manual-of-flake-attribute">Get manual of flake attribute</a></h2>
<p>Assuming derivations defined via a flake on github</p>
<pre><code class="language-shell">dream2nix man github:user/repo#some-package
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="consume-and-modify-dream2nix-packages"><a class="header" href="#consume-and-modify-dream2nix-packages">Consume and modify dream2nix packages</a></h1>
<h2 id="given-the-following-package"><a class="header" href="#given-the-following-package">Given the following package</a></h2>
<p><code>upstream/my-package.nix</code></p>
<pre><code class="language-nix">{config, lib, dream2nix, ...}: {

  imports = [
    dream2nix.modules.nodejs.mkDerivation
    dream2nix.modules.nodejs.package-lock
  ];

  pname = &quot;my-package&quot;;
  version = &quot;2.0.0&quot;;

  src = {
    type = github;
    owner = &quot;my-user&quot;;
    repo = &quot;my-repo&quot;;
    ref = config.version;
    hash = &quot;sha256-mia90VYv/YTdWNhKpvwvFW9RfbXZJSWhJ+yva6EnLE8=&quot;;
  };

  # declare dependency on python3
  deps = {nixpkgs, ...}: {
    python3 = nixpkgs.python39;
  };

  nativeBuildInputs = [
    config.deps.python3
  ];

  configurePhase = ''
    python3 --version
  '';

  buildPhase = ''
    python3 -c 'print(&quot;Hello World!&quot;)' &gt; $out
  '';
}
</code></pre>
<p><code>upstream/default.nix</code></p>
<pre><code class="language-nix">{
  nixpkgs ? import &lt;nixpkgs&gt; {},
  dream2nix ?
    import
    (builtins.fetchTarball &quot;https://dream2nix.dev/tarball/1.0&quot;)
    {inherit nixpkgs;},
}: {
  packages.my-package = dream2nix.eval ./my-package.nix;
}
</code></pre>
<h2 id="1-override-using-modules"><a class="header" href="#1-override-using-modules">1. Override using modules</a></h2>
<h3 id="11-define-a-module-for-the-override"><a class="header" href="#11-define-a-module-for-the-override">1.1 Define a module for the override</a></h3>
<p><code>my-package-override.nix</code></p>
<pre><code class="language-nix">{config, lib, ... }: {

  version = &quot;2.1.0&quot;;

  # No need to re-define other fetcher attributes.
  # The module system updates them for us.
  src.hash = &quot;sha256-LM5GDNjLcmgZVQEeANWAOO09KppwGaYEzJBjYmuSwys=&quot;;

  deps = {nixpkgs, ...}: {

    # change the python version
    python3 = lib.mkForce nixpkgs.python310;

    # add a dependency on hello  
    hello = nixpkgs.hello;
  };

  # add hello to nativeBuildInputs
  # (`oldAttrs.nativeBuildInputs + ...` not needed here)
  nativeBuildInputs = [
    config.deps.hello
  ];

  # add lines to configurePhase
  postConfigure = ''
    hello --version
  '';

  # replace the build phase via mkForce
  buildPhase = lib.mkForce &quot;
    hello &gt; $out
  &quot;;
}
</code></pre>
<h3 id="12-apply-my-package-overridenix-via-extendmodules"><a class="header" href="#12-apply-my-package-overridenix-via-extendmodules">1.2 Apply <code>my-package-override.nix</code> via extendModules</a></h3>
<p>Using <code>extendModules</code> is simple.
It allows to extend an existing package with another module.
This doesn't require knowledge about the original modules that went into the package.</p>
<p><code>./default.nix</code></p>
<pre><code class="language-nix">let
  nixpkgs = import &lt;nixpkgs&gt; {};
  upstream = import ./upstream {inherit nixpkgs;};
  my-package = upstream.packages.my-package;

  # The recommended way of modifying a package is using extendModules,
  #    which uses the module systems merge logic to apply changes.
  my-package-extended = my-package.extendModules {
    modules = [./my-package-override.nix];
  };

in {
  inherit my-package-extended;
}
</code></pre>
<h3 id="13-or-apply-my-package-overridenix-via-dream2nixeval"><a class="header" href="#13-or-apply-my-package-overridenix-via-dream2nixeval">1.3 Or apply <code>my-package-override.nix</code> via dream2nix.eval</a></h3>
<p>This approach is a bit cleaner.
It doesn't introduce a chain of extendModules function calls.
This style also makes it obvious which modules went into the package.
Though, this requires access to the original <code>my-package.nix</code> module and knowledge about the <code>packageSets</code> that went into it.</p>
<p><code>default.nix</code></p>
<pre><code class="language-nix">{
  nixpkgs ? import &lt;nixpkgs&gt; {},
  dream2nix ?
    import
    (builtins.fetchTarball &quot;https://dream2nix.dev/tarball/1.0&quot;)
    {inherit nixpkgs;},

}: let

  my-package-extended = dream2nix.eval
    {packagetSets = {inherit nixpkgs;};}
    [
      ./upstream/my-package.nix
      ./my-package-override.nix
    ];

in {
  my-package-extended
}
</code></pre>
<h2 id="2-override-package-via-overrideattrs-functions"><a class="header" href="#2-override-package-via-overrideattrs-functions">2. Override package via <code>override[Attrs]</code> functions</a></h2>
<p>It is recommended to use modules for overriding, like described above, but for backward compatibility, <code>overrideAttrs</code> and <code>override</code> are still supported.</p>
<pre><code class="language-nix">let
  nixpkgs = import &lt;nixpkgs&gt; {};
  upstream = import ./upstream {inherit nixpkgs;};
  my-package = upstream.packages.my-package;

  # Override the package via `override` and `overrideAttrs`
  my-package-overridden' = my-package.override
    (oldAttrs: {

      # change the python version
      python3 = nixpkgs.python310;
    });

  my-package-overridden = my-package-overridden'.overrideAttrs
    (oldAttrs: rec {

      version = &quot;2.1.0&quot;;

      src = nixpkgs.fetchFromGithub {
        owner = &quot;my-owner&quot;;
        repo = &quot;my-repo&quot;;
        ref = version;
        hash = &quot;sha256-LM5GDNjLcmgZVQEeANWAOO09KppwGaYEzJBjYmuSwys=&quot;;
      };

      # add hello to nativeBuildInputs
      nativeBuildInputs = [
        nixpkgs.hello
      ];

      # add lines to configurePhase
      postConfigure = ''
        hello --version
      '';

      # replace the build phase
      buildPhase = ''
        hello &gt; $out
      '';
    });

in {
  inherit my-package-overridden;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="integrate-lang2nix-tool-pure"><a class="header" href="#integrate-lang2nix-tool-pure">Integrate lang2nix tool (pure)</a></h1>
<p>We use <a href="https://crane.dev">crane</a> as an example here to demonstrate creating a dream2nix integration</p>
<p><code>dream2nix/modules/rust.crane-buildPackage.nix</code></p>
<pre><code class="language-nix">{config, lib, dream2nix, system, ...}: rec {

  imports = [
    # import generic mkDerivation interface, which will add options like:
    #   - buildInputs
    #   - nativeBuildInputs
    #   - ...
    dream2nix.modules.mkDerivation-interfaces
  ];

  options = {
    buildPhaseCargoCommand = lib.mkOption {
      description = &quot;A command to run during the derivation's build phase. Pre and post build hooks will automatically be run.&quot;;
      type = lib.types.nullOr lib.types.str;
      default = null;
    };
    cargoArtifacts = lib.mkOption {
      description = &quot;A path (or derivation) which contains an existing cargo target directory, which will be reused at the start of the derivation. Useful for caching incremental cargo builds.&quot;;
      type = lib.types.nullOr lib.types.str;
      default = null;
    };
    cargoBuildCommand = lib.mkOption {
      description = &quot;A cargo invocation to run during the derivation's build phase&quot;;
      type = lib.types.nullOr lib.types.str;
      default = null;
    }

    # ... more options of crane's buildPackage
  };

  config = {
    # signal that all options should be passed to the final derivation function
    argsForward = l.mapAttrs (_: _: true) options;

    # the final derivation is built by calling crane.buildPackage
    config.final.derivation =
      dream2nix.inputs.crane.lib.${system}.buildPackage
      config.final.derivation-args;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="integrate-lang2nix-tool-impurecode-gen"><a class="header" href="#integrate-lang2nix-tool-impurecode-gen">Integrate lang2nix tool (impure/code-gen)</a></h1>
<p>We use <a href="https://github.com/nix-community/gomod2nix">gomod2nix</a> as an example here to demonstrate creating a dream2nix integration.</p>
<p>Gomod2nix is a nix code generator that requires network access, a great example for an impure dream2nix integration.</p>
<p><code>dream2nix/modules/go.gomod2nix.nix</code></p>
<pre><code class="language-nix">{config, lib, dream2nix, system, ...}: rec {

  imports = [

    # import generic mkDerivation interface, which will add options like:
    #   - buildInputs
    #   - nativeBuildInputs
    #   - ...
    dream2nix.modules.mkDerivation-interfaces

    # Generic interface for impure lang2nix tools (code generators)
    #   This provides options like `generateBin` (see below)
    dream2nix.modules.integrations.impure
  ];

  options = {
    modules = lib.mkOption {
      description = &quot;The path to the gomod2nix.toml&quot;;
      type = lib.types.str;
      default = &quot;${config.dream2nix.artifactsLocation}/gomod2nix.toml&quot; ;
    };

  };

  config = {
    # Generated code will end up in:
    #   {repo}/dream2nix/artifacts/{engineName}/{package_identifier}
    dream2nix.engineName = &quot;gomod2nix&quot;;

    # An executable that generates nix code for the given `src`
    dream2nix.generateBin = dream2nix.utils.writePureShellScript &quot;gomod2nix-generate.sh&quot;
      [
        # add gomod2nix tool to PATH
        dream2nix.inputs.gomod2nix.packages.${system}.gomod2nix
      ]
      ''
        targetDir=$1
        gomod2nix --dir &quot;${config.src}&quot; --outdir &quot;$targetDir&quot;
      '';

    # signal that all options should be passed to the final derivation function
    argsForward = l.mapAttrs (_: _: true) options;

    # the final derivation is built by calling gomod2nix.buildGoApplication
    config.final.derivation =
      dream2nix.inputs.gomod2nix.lib.${system}.buildGoApplication
      config.final.derivation-args;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-roundup-april---june-2022"><a class="header" href="#development-roundup-april---june-2022">Development Roundup April - June 2022</a></h1>
<p>In the period of 3 months, <a href="https://github.com/nix-community/dream2nix/pulls?page=1&amp;q=is%3Apr+sort%3Acreated-asc+merged%3A2022-06+merged%3A2022-05+merged%3A2022-04">40 pull requests were merged</a>.</p>
<h2 id="most-notable-changes"><a class="header" href="#most-notable-changes">Most Notable Changes</a></h2>
<h3 id="extension-interface-for-subsystem-modules"><a class="header" href="#extension-interface-for-subsystem-modules">Extension Interface for subsystem modules</a></h3>
<p>Dream2nix now has an extension interface which allows users to add support for other ecosystems and lock file formats out of tree. This allows people to maintain private dream2nix extensions or publish their extensions on their own repositories. For the future it is planned to go one step further and use the nixos module system for dream2nix.</p>
<h3 id="improved-handling-of-mono-repo-projects"><a class="header" href="#improved-handling-of-mono-repo-projects">Improved handling of mono-repo projects</a></h3>
<p>Many software projects in the wild consist of several sub-project. The sub-projects could be of the same ecosystem, like a nodejs project managed by npm, declaring several workspaces, or they could be of completely different ecosystems, like a nodejs project, containing a rust and a go module within the same source tree. A goal for dream2nix is to handle all these constellations well, to provide the user with decent automation and interfaces in order to simplify working with these complex software projects as much as possible. Therefore a discovery mechanism has been established and improved over time to tackle mono-repo scenarios, detecting sub-projects of arbitrary type within a larger source tree, splitting the detected projects into reasonable chunks of work that can be processed by many different translator modules of dream2nix.</p>
<h3 id="unit-tests-for-pure-translators"><a class="header" href="#unit-tests-for-pure-translators">Unit tests for pure translators</a></h3>
<p>Pure translators are the parts of dream2nix which are able to read upstream lock files and other metadata and convert this data to the dream2nix internal dream-lock format. All of this in done in pure nix without calling to external programs. For example the cargo-lock translator allows dream2nix to just build any rust project on-the-fly, given just the source code of the project.
In order for dream2nix to extend its support onto many more ecosystems, we rely on the community contributions adding pure translators. For this reason we want to make such contributions as simple as possible.
This is why we established a unit testing suit for pure translators. This is realized by using python + pytest to define the unit tests which then call out to nix via our python nix-ffi. This allows people to implement new translators step by step while getting constant feedback if they are on the right track.</p>
<h2 id="more-changes"><a class="header" href="#more-changes">More Changes</a></h2>
<ul>
<li>
<p>Reorganized internal code structure of <code>dream2nix</code> (<code>builders</code>, <code>translators</code>, <code>discoverers</code> moved to <code>subsystems</code>)</p>
</li>
<li>
<p>New community overrides to fix some nodejs packages</p>
</li>
<li>
<p>Improved usage examples in readme</p>
</li>
<li>
<p>Improvements on several subsystems including nodejs and rust</p>
</li>
<li>
<p>New documentation website:
https://nix-community.github.io/dream2nix/</p>
</li>
<li>
<p>Added subsystems:</p>
<ul>
<li>python</li>
<li>haskell</li>
</ul>
</li>
<li>
<p>Added support for translating formats:</p>
<ul>
<li>python: setup.py</li>
<li>haskell: stack.yaml.lock (stack)</li>
<li>haskell: plan.json (cabal)</li>
<li>rust: Cargo.toml, Cargo.lock</li>
</ul>
</li>
<li>
<p>Added builders for:</p>
<ul>
<li>haskell: <code>default</code></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-roundup-july---september-2022"><a class="header" href="#development-roundup-july---september-2022">Development Roundup July - September 2022</a></h1>
<p>In the period of 3 months, <a href="https://github.com/nix-community/dream2nix/pulls?q=is%3Apr+sort%3Acreated-asc+merged%3A2022-09+merged%3A2022-08+merged%3A2022-07+">62 pull requests were merged</a>.</p>
<h2 id="most-notable-changes-1"><a class="header" href="#most-notable-changes-1">Most Notable Changes</a></h2>
<h3 id="indexers"><a class="header" href="#indexers">Indexers</a></h3>
<p>Dream2nix now offers an interface for defining <code>indexers</code>. Indexers are programs that can query a package repository (think of npm, or crates.io) for package information. Read <a href="development-roundups/../intro/indexers.html">more about indexers in our docs</a>.</p>
<p>Indexers can be used to automatically import packages from all kinds of ecosystems into the nix domain. For example the <code>libraries-io</code> indexer can be used to query libraries.io for the 5000 most popular nodejs packages and convert them to nix packages.</p>
<p>One nice use case for indexers is to test dream2nix by continuously building large auto generated package sets while monitoring the success rate and get useful information from build failures.</p>
<p>Currently we already have this testing infrastructure set up for nodejs and rust (more will be added soon). The package sets can be found in the repo: <a href="https://github.com/nix-community/dream2nix-auto-test">nix-community/dream2nix-auto-test</a></p>
<h3 id="development-shells"><a class="header" href="#development-shells">development shells</a></h3>
<p>Besides the usual packages, many builders in dream2nix do now also output dev-shell(s) via the <code>devShells</code> attribute. This should allow developers to quickly spin up a shell environment on arbitrary projects with the required dependencies available to start hacking.</p>
<h3 id="begin-moving-to-nixos-module-system"><a class="header" href="#begin-moving-to-nixos-module-system">Begin moving to nixos module system</a></h3>
<p>We started a larger refactoring effort, separating dream2nix internals into nixos modules. The goal of this undertaking is to gain:</p>
<ul>
<li>better flexibility within the framework. People should have an easier time to modify and extend the framework</li>
<li>type safety between important components of dream2nix</li>
<li>type checked and automatically documented user interfaces (similar to search.nixos.org for nixos)</li>
<li>better integration into nixos itself</li>
</ul>
<p>This is only partially complete yet, as we have to refactor module by module carefully while making sure to not break the current API. Currently, only translators, fetchers, builders and discoverers use the module system. Once the internals are <code>modularized</code>, the final piece of work will be creating a new user interface using nixos modules as well.</p>
<h2 id="more-changes-1"><a class="header" href="#more-changes-1">More Changes</a></h2>
<ul>
<li>
<p>Improvements on several subsystems including haskell, nodejs, python, rust</p>
</li>
<li>
<p>Improvements of some community overrides</p>
</li>
<li>
<p>Added quick start guides to the documentation</p>
</li>
<li>
<p>Several improvements for the documentation</p>
</li>
<li>
<p>Added integration tests</p>
</li>
<li>
<p>Added subsystems:</p>
<ul>
<li>debian</li>
<li>php</li>
</ul>
</li>
<li>
<p>Added support for translating formats:</p>
<ul>
<li>debian: debian-binary (impure)</li>
<li>php: composer-lock  (pure)</li>
<li>haskell: hackage (impure) - given a package name, retrieve metadata from hackage</li>
</ul>
</li>
<li>
<p>Added builders for:</p>
<ul>
<li>debian <code>simple-debian</code>: download and patch binary releases from debian repos</li>
<li>php <code>simple-php</code>: build dependencies in a combined derivation</li>
<li>php <code>granular-php</code>: build dependencies in separate derivations</li>
</ul>
</li>
<li>
<p>Added indexers:</p>
<ul>
<li>libraries-io: queries <a href="https://libraries.io/">libraries.io</a> for package sets</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
